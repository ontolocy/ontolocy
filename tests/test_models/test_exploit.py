from ontolocy import CVE, Exploit, ExploitExploitsVulnerability


def test_exploit():
    exploit = Exploit(name="51031", url="https://www.exploit-db.com/exploits/51031")

    assert exploit.name == "51031"


def test_exploit_cve(use_graph):
    exploit = Exploit(name="51031", url="https://www.exploit-db.com/exploits/51031")
    exploit.merge()

    cve = CVE(cve_id="CVE-2022-37661")
    cve.merge()

    rel = ExploitExploitsVulnerability(source=exploit, target=cve)
    rel.merge()

    cypher = f"""
    MATCH (exploit:Exploit)-[r:EXPLOIT_EXPLOITS_VULNERABILITY]->(cve:CVE)
    WHERE exploit.unique_id = $exploit_id
    RETURN COUNT(DISTINCT r)
    """

    params = {"exploit_id": exploit.get_primary_property_value()}

    result = use_graph.evaluate_query_single(cypher, params)

    assert result == 1
